name: Auto-merge Automated PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
  check_suite:
    types: [completed]
  workflow_run:
    workflows: ["Build and Push Containers"]
    types: [completed]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: read

    steps:
      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Get PR number from workflow run
            PR_NUMBER=$(gh pr list --repo ${{ github.repository }} --head ${{ github.event.workflow_run.head_branch }} --json number --jq '.[0].number')
            echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if PR has automated label
        id: check_label
        if: steps.pr.outputs.number
        run: |
          LABELS=$(gh pr view ${{ steps.pr.outputs.number }} --repo ${{ github.repository }} --json labels --jq '.labels[].name')
          if echo "$LABELS" | grep -q "automated"; then
            echo "is_automated=true" >> $GITHUB_OUTPUT
            echo "PR is automated, proceeding with auto-merge check"
          else
            echo "is_automated=false" >> $GITHUB_OUTPUT
            echo "PR is not automated, skipping auto-merge"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for checks to complete
        if: steps.check_label.outputs.is_automated == 'true'
        run: |
          echo "Waiting for all checks to complete..."
          sleep 30

      - name: Check PR status and merge
        if: steps.check_label.outputs.is_automated == 'true'
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}

          # Get PR status
          PR_STATE=$(gh pr view $PR_NUMBER --repo ${{ github.repository }} --json state --jq '.state')

          if [ "$PR_STATE" != "OPEN" ]; then
            echo "PR is not open, skipping"
            exit 0
          fi

          # Check if all status checks passed
          CHECKS_STATUS=$(gh pr checks $PR_NUMBER --repo ${{ github.repository }} --json state --jq 'all(.state == "SUCCESS" or .state == "SKIPPED")')

          if [ "$CHECKS_STATUS" = "true" ]; then
            echo "All checks passed, merging PR..."
            gh pr merge $PR_NUMBER --repo ${{ github.repository }} --squash --auto --delete-branch
            echo "‚úÖ PR #$PR_NUMBER has been set to auto-merge"
          else
            echo "‚è≥ Checks are still pending or failed, not merging"
            gh pr checks $PR_NUMBER --repo ${{ github.repository }}
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on merge
        if: steps.check_label.outputs.is_automated == 'true'
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          gh pr comment $PR_NUMBER --repo ${{ github.repository }} --body "ü§ñ Auto-merge enabled. This PR will be merged automatically once all checks pass."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
