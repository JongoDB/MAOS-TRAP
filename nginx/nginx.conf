user  nginx;
worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
  worker_connections 1024;
}

http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile      on;
  keepalive_timeout 65;

  # Docker DNS resolver
  resolver 127.0.0.11 valid=30s;

  gzip on;
  gzip_types text/css application/javascript application/json text/plain image/svg+xml;

  # -------------------- Upstreams --------------------
  upstream attack_website   { server attack-website:80; }
  upstream attack_navigator { server attack-navigator:80; }
  upstream attack_flow      { server attack-flow:80; }
  upstream attack_flow_viz  { server attack-flow-viz:80; }
  # ---------------------------------------------------

  server {
    listen 80;
    server_name _;
    return 301 https://$host$request_uri;
  }

  server {
    listen 443 ssl;
    http2 on;
    server_name _;

    ssl_certificate     /etc/nginx/certs/maos-trap.crt;
    ssl_certificate_key /etc/nginx/certs/maos-trap.key;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    proxy_buffering on;
    proxy_buffers 16 64k;
    proxy_buffer_size 128k;

    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    client_max_body_size 100m;

    # Landing page
    location = / {
      root /usr/share/nginx/html;
      try_files /index.html =404;
    }

    # Redirect without trailing slash
    location ~ ^/(attack-website|attack-navigator|attack-flow|attack-flow-viz)$ {
      return 301 https://$http_host$uri/;
    }

    location = /api/system-metrics {
      proxy_pass http://system-metrics:9000/metrics;
      proxy_http_version 1.1;
      proxy_set_header Host              $http_host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host  $http_host;
      add_header Cache-Control "no-store";
    }

    location ^~ /attack-website/ {
      proxy_pass http://attack_website;
      proxy_http_version 1.1;
      proxy_set_header Host              $http_host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host  $http_host;
      proxy_set_header X-Forwarded-Prefix /attack-website;
      proxy_set_header Upgrade           $http_upgrade;
      proxy_set_header Connection        "upgrade";
      proxy_redirect off;
    }

    location ^~ /attack-navigator/ {
      proxy_pass http://attack_navigator;
      proxy_http_version 1.1;
      proxy_set_header Host              $http_host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host  $http_host;
      proxy_set_header X-Forwarded-Prefix /attack-navigator;
      proxy_set_header Upgrade           $http_upgrade;
      proxy_set_header Connection        "upgrade";
      proxy_redirect off;
    }

    location ^~ /attack-flow/ {
      proxy_pass http://attack_flow;
      proxy_http_version 1.1;
      proxy_set_header Host              $http_host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host  $http_host;
      proxy_set_header X-Forwarded-Prefix /attack-flow;
      proxy_set_header Upgrade           $http_upgrade;
      proxy_set_header Connection        "upgrade";
      proxy_redirect off;
    }

    location ^~ /attack-flow-viz/ {
      proxy_pass http://attack_flow_viz/;
      proxy_http_version 1.1;
      proxy_set_header Host              $http_host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host  $http_host;
      proxy_set_header X-Forwarded-Prefix /attack-flow-viz;
      proxy_set_header Upgrade           $http_upgrade;
      proxy_set_header Connection        "upgrade";
      proxy_redirect off;
    }

    # Health
    location = /healthz {
      return 200 'ok';
      add_header Content-Type text/plain;
    }
  }
}
